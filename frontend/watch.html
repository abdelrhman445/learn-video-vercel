<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุดุงูุฏุฉ ุงูููุฏูู - ูุธุงู ุงูููุฏูู</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="terminal-effect">
    <nav class="navbar">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <a href="/" class="navbar-brand">
                <span class="glitch-text" data-text="VIDEO_OPS">VIDEO_OPS</span>
            </a>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div data-admin-links></div>
                <div id="authButtons"></div>
            </div>
        </div>
    </nav>

    <div class="container" id="mainContent">
        <!-- ุณูุชู ุชุญููู ุงููุญุชูู ููุง ุจูุงุกู ุนูู ุญุงูุฉ ุงููุตุงุฏูุฉ -->
    </div>

    <script src="js/auth.js"></script>
    <script>
        let currentVideoId = null;

        // ุงูุชุญูู ูู ุญุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ูุนุฑุถ ุงููุญุชูู ุงูููุงุณุจ
        function checkAuthStatus() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('user');
            
            if (token && user) {
                // ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู - ุชุญููู ูุญุชูู ุงูููุฏูู
                loadVideoContent();
            } else {
                // ุงููุณุชุฎุฏู ุบูุฑ ูุณุฌู ุฏุฎูู - ุนุฑุถ ุฑุณุงูุฉ
                showGuestMessage();
            }
        }

        function showGuestMessage() {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="card">
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 4rem; color: var(--accent-color); margin-bottom: 1.5rem;">
                            <i class="fas fa-lock"></i>
                        </div>
                        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ููุดุงูุฏุฉ ุงูููุฏูู</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem; line-height: 1.6;">
                            ูุง ููููู ูุดุงูุฏุฉ ูุฐุง ุงูููุฏูู ุจุฏูู ุชุณุฌูู ุงูุฏุฎูู.<br>
                            ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ุฃู ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ ูููุตูู ุฅูู ุงููุญุชูู.
                        </p>
                        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <a href="/login.html" class="btn">
                                <i class="fas fa-sign-in-alt"></i>
                                ุชุณุฌูู ุงูุฏุฎูู
                            </a>
                            <a href="/register.html" class="btn btn-outline">
                                <i class="fas fa-user-plus"></i>
                                ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadVideoContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');

            if (!videoId) {
                showError('ูุนุฑู ุงูููุฏูู ุบูุฑ ุตุงูุญ');
                return;
            }

            currentVideoId = videoId;

            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`/api/videos/${videoId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    showError('ุงูุชูุช ุฌูุณุชู. ูุฑุฌู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู.');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return;
                }

                if (response.status === 403) {
                    showError('ุบูุฑ ูุณููุญ ูู ุจูุดุงูุฏุฉ ูุฐุง ุงูููุฏูู.');
                    return;
                }

                if (response.status === 404) {
                    showError('ุงูููุฏูู ุบูุฑ ููุฌูุฏ ุฃู ุชู ุญุฐูู.');
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    displayVideo(data.data.video);
                } else {
                    showError(data.message || 'ุฎุทุฃ ูู ุชุญููู ุงูููุฏูู');
                }
            } catch (error) {
                console.error('Error loading video:', error);
                showError('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ');
            }
        }

        function displayVideo(video) {
            const container = document.getElementById('mainContent');
            
            container.innerHTML = `
                <div id="videoPlayerContainer">
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        ุฌุงุฑู ุชุญููู ุงูููุฏูู...
                    </div>
                </div>

                <div class="card" id="videoInfoCard" style="display: none;">
                    <div class="card-header" id="videoTitle">ุนููุงู ุงูููุฏูู</div>
                    <div id="videoDescription" style="color: var(--text-secondary); line-height: 1.6;">
                        ูุตู ุงูููุฏูู...
                    </div>
                    <div style="margin-top: 1rem; display: flex; gap: 2rem; color: var(--text-secondary); font-size: 0.9rem;">
                        <span id="videoViews">0 ูุดุงูุฏุฉ</span>
                        <span id="videoDate">ุบูุฑ ูุญุฏุฏ</span>
                        <span id="videoPrivacy">ุนุงู</span>
                    </div>
                </div>

                <!-- ุฑุณุงูุฉ ุงูุฎุทุฃ -->
                <div id="errorMessage" class="alert alert-error" style="display: none; margin-top: 2rem;">
                    <strong>ุฎุทุฃ ูู ุชุดุบูู ุงูููุฏูู:</strong>
                    <span id="errorText"></span>
                    <div style="margin-top: 1rem;">
                        <button class="btn" onclick="retryLoadVideo()">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
                        <a href="/" class="btn" style="margin-right: 1rem;">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
                    </div>
                </div>

                <!-- ุฑุงุจุท ุจุฏูู ููููุฏูู -->
                <div id="alternativeLink" class="card" style="display: none; margin-top: 2rem;">
                    <div class="card-header">ุฑุงุจุท ุจุฏูู ููููุฏูู</div>
                    <div style="padding: 1.5rem;">
                        <p style="margin-bottom: 1rem;">ููููู ูุดุงูุฏุฉ ุงูููุฏูู ูุจุงุดุฑุฉ ุนูู YouTube:</p>
                        <a id="directYoutubeLink" href="#" target="_blank" class="btn" style="display: inline-block;">
                            <i class="fab fa-youtube"></i> ูุดุงูุฏุฉ ุนูู YouTube
                        </a>
                    </div>
                </div>
            `;

            // ุฅูุดุงุก iframe ููุดุบู YouTube
            const videoContainer = document.getElementById('videoPlayerContainer');
            const iframe = document.createElement('iframe');
            iframe.width = "100%";
            iframe.height = "600";
            iframe.src = `https://www.youtube.com/embed/${video.youtubeId}`;
            iframe.title = video.title;
            iframe.frameBorder = "0";
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.allowFullscreen = true;
            iframe.referrerPolicy = "strict-origin-when-cross-origin";
            
            iframe.onload = function() {
                console.log('โ ุชู ุชุญููู iframe ุจูุฌุงุญ');
            };
            
            iframe.onerror = function() {
                console.error('โ ุฎุทุฃ ูู ุชุญููู iframe');
                handleVideoError(video);
            };

            videoContainer.innerHTML = '';
            videoContainer.appendChild(iframe);

            // ุนุฑุถ ูุนูููุงุช ุงูููุฏูู
            document.getElementById('videoTitle').textContent = video.title;
            document.getElementById('videoDescription').textContent = video.description || 'ูุง ููุฌุฏ ูุตู';
            document.getElementById('videoViews').textContent = `${video.views} ูุดุงูุฏุฉ`;
            document.getElementById('videoDate').textContent = new Date(video.createdAt).toLocaleDateString('ar-EG');
            document.getElementById('videoPrivacy').textContent = 
                video.privacy === 'public' ? 'ุนุงู' : 
                video.privacy === 'private' ? 'ุฎุงุต' : 'ุบูุฑ ูุฏุฑุฌ';
            
            document.getElementById('videoInfoCard').style.display = 'block';

            // ุฅุนุฏุงุฏ ุงูุฑุงุจุท ุงูุจุฏูู
            document.getElementById('directYoutubeLink').href = video.url;
            
            // ุงูุชุญูู ูู ุญุงูุฉ ุงูููุฏูู ุจุนุฏ ูุชุฑุฉ
            setTimeout(() => {
                checkVideoStatus(iframe, video);
            }, 3000);
        }

        function checkVideoStatus(iframe, video) {
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const errorElements = iframeDoc.querySelectorAll('[class*="error"], [id*="error"]');
                if (errorElements.length > 0) {
                    handleVideoError(video);
                }
            } catch (error) {
                console.log('โ๏ธ ูุง ูููู ุงูุชุญูู ูู ุญุงูุฉ ุงูููุฏูู ุจุณุจุจ CORS');
                if (iframe.src && !iframe.src.includes('about:blank')) {
                    console.log('โ ูุจุฏู ุฃู ุงูููุฏูู ูุญูู ุจูุฌุงุญ');
                } else {
                    handleVideoError(video);
                }
            }
        }

        function handleVideoError(video) {
            console.log('๐ฌ ูุนุงูุฌุฉ ุฎุทุฃ ุงูููุฏูู:', video.youtubeId);
            
            const container = document.getElementById('videoPlayerContainer');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; background: var(--secondary-bg); border-radius: 8px;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">โ</div>
                    <h3 style="color: var(--danger); margin-bottom: 1rem;">ุชุนุฐุฑ ุชุญููู ุงูููุฏูู</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        ูุฏ ูููู ุงูููุฏูู ุฎุงุตุงู ุฃู ุบูุฑ ูุฏุฑุฌ ููุง ูููู ุนุฑุถู ููุง.<br>
                        ููููู ูุดุงูุฏุชู ูุจุงุดุฑุฉ ุนูู YouTube.
                    </p>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <a href="${video.url}" target="_blank" class="btn" style="background: var(--danger);">
                            <i class="fab fa-youtube"></i> ูุดุงูุฏุฉ ุนูู YouTube
                        </a>
                        <button class="btn" onclick="retryLoadVideo()">
                            <i class="fas fa-redo"></i> ุฅุนุงุฏุฉ ุงููุญุงููุฉ
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('alternativeLink').style.display = 'block';
            
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.role === 'admin') {
                container.innerHTML += `
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <strong>ูุนูููุงุช ูููุณุคูู:</strong><br>
                        ูุนุฑู ุงูููุชููุจ: <code>${video.youtubeId}</code><br>
                        ุงูุฎุตูุตูุฉ: ${video.privacy}<br>
                        ุงูุญููู ุงูููุชุฑุญุฉ:<br>
                        1. ุชุฃูุฏ ูู ุฃู ุงูููุฏูู <strong>ุนุงู (Public)</strong> ุนูู YouTube<br>
                        2. ุฅุฐุง ูุงู ุงูููุฏูู <strong>ุบูุฑ ูุฏุฑุฌ (Unlisted)</strong>ุ ุชุฃูุฏ ูู ุตุญุฉ ุงูุฑุงุจุท<br>
                        3. ุฅุฐุง ูุงู ุงูููุฏูู <strong>ุฎุงุต (Private)</strong>ุ ูุง ูููู ุนุฑุถู ููุง
                    </div>
                `;
            }
        }

        function showError(message) {
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="alert alert-error">
                    <strong>ุฎุทุฃ:</strong> ${message}
                    <div style="margin-top: 1rem;">
                        <a href="/" class="btn">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
                    </div>
                </div>
            `;
        }

        function retryLoadVideo() {
            loadVideoContent();
        }

        // ุงูุชููุฆุฉ ุนูุฏ ุชุญููู ุงูุตูุญุฉ
        document.addEventListener('DOMContentLoaded', checkAuthStatus);
    </script>
</body>
</html>